From f8b9085df3c214526254d579e6811a9e6e2ce9cf Mon Sep 17 00:00:00 2001
From: Nick Bofferding <bofferdn@us.ibm.com>
Date: Thu, 22 Sep 2016 13:35:36 -0500
Subject: [PATCH] Add delay before checking if slave SBEs were started

Change-Id: I1b17cea15b1ad5fd85a99e42c20fe1ba07d22a60
---
 src/usr/hwpf/hwp/slave_sbe/slave_sbe.C | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/src/usr/hwpf/hwp/slave_sbe/slave_sbe.C b/src/usr/hwpf/hwp/slave_sbe/slave_sbe.C
index aa12b5f..09a231c 100644
--- a/src/usr/hwpf/hwp/slave_sbe/slave_sbe.C
+++ b/src/usr/hwpf/hwp/slave_sbe/slave_sbe.C
@@ -68,9 +68,11 @@
 #include <freqVoltageSvc.H>
 #include <config.h>
 #include <pnor/pnorif.H>
+#include <sys/time.h>
 
 const uint64_t MS_TO_WAIT_FIRST = 2500; //(2.5 s)
 const uint64_t MS_TO_WAIT_OTHERS= 100; //(100 ms)
+const uint64_t MS_TO_WAIT_FIRST_SBE_START = 100; //(100 ms)
 
 using namespace ISTEP;
 using namespace ISTEP_ERROR;
@@ -448,6 +450,12 @@ void* call_proc_check_slave_sbe_seeprom_complete( void *io_pArgs )
     TRACFCOMP( ISTEPS_TRACE::g_trac_isteps_trace,
                "call_proc_check_slave_sbe_seeprom_complete entry" );
 
+    // Secureboot code pins the SBE image such that it doesn't need to be
+    // re-read from PNOR.  In that case, Hostboot races ahead so fast that it
+    // doesn't see SBE as started in the HWP.  Give some time for the SBEs to
+    // start.
+    nanosleep(0,MS_TO_WAIT_FIRST_SBE_START*NS_PER_MSEC);
+
     //If in FSPless environment -- give time for SBE to complete on first chip
     if (!INITSERVICE::spBaseServicesEnabled())
     {
-- 
1.8.2.2

